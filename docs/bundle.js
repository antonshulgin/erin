(e=>{"use strict";function t(e=0){return e>1e3?`${(e/1e3).toFixed(1)}k`:e}window.addEventListener("DOMContentLoaded",(function(){const t={controls:document.getElementById("Controls"),overview:document.getElementById("Overview")},n={lookup:e.Lookup({onResolved:function(n=[]){console.log({fetchSystems:n}),r(),Promise.any(n.map((n=>function(n){const o=e.System(n);function r(){setTimeout((()=>o.fetchDetails()),Math.round(7*Math.random()))}t.overview.appendChild(o.render()),e.libCache.getItem(`systemIds/${n}`).then((()=>{r()})).catch((()=>{e.libCache.saveItem(`systemIds/${n}`,n),r()}))}(n)))).then(o).catch(console.error)}})};function o(n){t.overview.classList.toggle("hidden",n?.length<=0),e.libCache.clearExpired()}function r(){e.libNet.resetTimedQueryCount(),t.overview.classList.toggle("hidden",!0),t.overview.replaceChildren()}r(),t.controls.appendChild(n.lookup.render()),n.lookup.setFocus()}),{once:!0,passive:!0}),e.ENDPOINT_ESI="https://esi.evetech.net/dev",e.ENDPOINT_ZKB="https://zkillboard.com/api",e.TYPE_IDS_IGNORED=[33328,33474,33475,57319,670,NaN,null,void 0],e.THOUSAND=1e3,e.MILLION=1e3*e.THOUSAND,e.BILLION=1e3*e.MILLION,e.TRILLION=1e3*e.BILLION,e.humanisePlural=function(e,n,o){return 1===e?`${t(e)} ${n}`:`${t(e)} ${o||n}`},e.humaniseCount=t,e.humaniseDate=function(e=new Date){return e?.toLocaleDateString()||"???"},e.humaniseTime=function(e=new Date){const t=e.getHours().toString().padStart(2,0),n=e.getMinutes().toString().padStart(2,0);return`${t}:${n}`},e.humaniseIsk=function(t=0){if(t>=e.TRILLION)return`${(t/e.TRILLION).toFixed(1)}T ISK`;if(t>=e.BILLION)return`${(t/e.BILLION).toFixed(1)}B ISK`;if(t>=e.MILLION)return`${(t/e.MILLION).toFixed(1)}M ISK`;if(t>=e.THOUSAND)return`${(t/e.THOUSAND).toFixed(1)}k ISK`;return`${t.toFixed(1)} ISK`},e.getIskScale=function(t=0){if(t>=e.BILLION)return"high";if(t>=e.MILLION)return"medium";if(t>=e.THOUSAND)return"low";return"none"}})(window.E={}),(e=>{"use strict";const t={};function n(e={}){if(!e?.lastCached)return!0;return Math.abs(Date.now()-e.lastCached)>=6e5}function o(e=""){return new Promise(((t,n)=>{let o;try{o=JSON.parse(e)}catch(t){return console.warn("Failed to decode JSON",{jsonString:e}),n(e)}return t(o)}))}e.libCache={clearExpired:function(){return new Promise(((e,r)=>(Object.values(t).forEach((e=>{o(e).then((e=>{var o;n(e)&&(o=e.key,new Promise((e=>(delete t[o],e()))))})).catch(r)})),e())))},getItem:function(e){return new Promise(((r,s)=>{o(t[e]).then((function(e={}){return n(e)?s():r(e.value)})).catch(s)}))},saveItem:function(e,n={}){return new Promise(((o,r)=>{const s={key:e,value:n,lastCached:Date.now()};(function(e={}){return new Promise(((t,n)=>{let o;try{o=JSON.stringify(e)}catch(t){return console.warn("Failed to encode JSON",{json:e}),n(e)}return t(o)}))})(s).then((function(n){return t[e]=n,o(s.value)})).catch(r)}))}}})(window.E),(e=>{"use strict";const t={timedQueryCount:0};e.libNet={resetTimedQueryCount:function(){t.timedQueryCount=0},load:function(n="",o=!1){return new Promise(((r,s)=>{if(!n)return console.error("No URL given"),s();function i(){fetch(n).then((e=>e.json())).then((t=>e.libCache.saveItem(n,t))).then((e=>r(e))).catch(s)}e.libCache.getItem(n).then((e=>r(e))).catch((()=>setTimeout(i,o?1111*(t.timedQueryCount+=1,t.timedQueryCount||0):0)))}))}}})(window.E),(e=>{"use strict";const t=document.getElementById("templateLookup"),n=/^([a-zA-Z0-9\- ]+)$/,o=/^Current location: (.+)$/,r=/^â€¢\s+(.+)$/,s=/^\d+\.\s+(.+?)\s\(/;e.Lookup=(i={})=>{const c=document.importNode(t.content,!0).firstChild;return c.addEventListener("submit",(function(e){e.preventDefault(),c.doLookup.textContent="Working",c.doLookup.classList.toggle("busy",!0),Promise.resolve(c.systems.value).then((e=>a(e))).then((e=>function(e=[]){return new Promise(((t,n)=>{Promise.all(e.map(l)).then((e=>t(e.flat(1)))).catch(n)}))}(e))).then((e=>function(e){return function(){c.doLookup.textContent="Ready",c.doLookup.classList.toggle("busy",!0),setTimeout(m,1e3)}(),i?.onResolved(e)}(e))).catch(d)})),c.systems.addEventListener("focus",u),{setFocus:u,render:function(){return c},parseSystems:a};function u(){c.systems.select()}function a(e=""){return new Promise((t=>t(e.split("\n").map((e=>e.trim())).reduce(((e,t)=>{const i=n.exec(t)?.[1]||r.exec(t)?.[1]||o.exec(t)?.[1]||s.exec(t)?.[1];return i&&i.length>0&&e.push(i),e}),[]))))}function l(t=""){return new Promise(((n,o)=>{e.libNet.load(`${e.ENDPOINT_ESI}/search/?search=${encodeURIComponent(t)}&categories=solar_system&strict=true`).then((function(e){const t=e.solar_system;return n(t)})).catch(o)}))}function d(e){console.error(e),c.doLookup.textContent="Could not",c.doLookup.classList.toggle("busy",!0),setTimeout(m,1e3)}function m(){c.doLookup.textContent="Look up",c.doLookup.classList.toggle("busy",!1)}}})(window.E),(e=>{"use strict";const t=document.getElementById("templateEncounter");e.Encounter=(n={},o={})=>{const r=document.importNode(t.content,!0).firstChild,s={time:r.querySelector(".Encounter-time"),victim:r.querySelector(".Encounter-victim"),attackers:r.querySelector(".Encounter-attackers"),iskDestroyed:r.querySelector(".Encounter-isk-destroyed")};var i,c;return i=n.killmail_id,r.href=`https://zkillboard.com/kill/${i}/`,c=n.killmail_time,s.time.textContent=e.humaniseTime(new Date(c)),function(t=0){s.iskDestroyed.dataset.threat=e.getIskScale(t),s.iskDestroyed.textContent=e.humaniseIsk(t)}(o.zkb.totalValue),{fetchDetails:function(){console.log({fetchDetails:n});const t=n.attackers.map((t=>e.Pilot(t,!0,!1))),o=e.Pilot(n.victim,!1,!0);o.fetchDetails(),t.map((e=>e.fetchDetails())),s.victim.replaceChildren(o.render()),s.attackers.replaceChildren(...t.map((e=>e.render())))},render:function(){return r}}}})(window.E),(e=>{"use strict";const t=document.getElementById("templateSystem");e.System=n=>{const o=document.importNode(t.content,!0).firstChild,r={summary:o.querySelector(".System-summary"),name:o.querySelector(".System-name"),status:o.querySelector(".System-status"),encounters:o.querySelector(".System-encounters"),iskDestroyed:o.querySelector(".System-isk-destroyed"),doGetEncounters:o.querySelector(".System-do-get-encounters")};return r.doGetEncounters.addEventListener("click",s,{passive:!0}),{render:function(){return o},fetchDetails:s,getId:l};function s(){!function(){function t(e){var t;console.log("System.doResolve",{info:e}),t=e.name,r.name.href=`https://zkillboard.com/system/${l()}`,r.name.textContent=t,function(e=0){e=e.toFixed(1)||"N/A",r.status.dataset.status=function(e=0){if(e<=0)return"high";if(e<.5)return"medium";if(e<1)return"low";return"none"}(e),r.status.textContent=e,r.status.classList.toggle("busy",!1)}(e.security_status)}function n(e){r.portrait.classList.toggle("busy",!1),console.error("Failed to load system info",{event:e})}e.libNet.load(`${e.ENDPOINT_ESI}/universe/systems/${l()}/`).then(t).catch(n)}(),function(){function t(){o.dataset.stateEncounters="loading",r.doGetEncounters.textContent="Getting encounters"}function n(){o.dataset.stateEncounters="ready",r.doGetEncounters.textContent="Get encounters"}function s(e){console.error(e),r.doGetEncounters.textContent="Could not",setTimeout((()=>{o.dataset.stateEncounters="failed",r.doGetEncounters.textContent="Get encounters"}),1e3)}t(),e.libNet.load(`${e.ENDPOINT_ZKB}/losses/solarSystemID/${l()}/`,!0).then((t=>function(t){console.log({parseEncounters:t});const n=t.filter((e=>!e.zkb.npc)).slice(0,13).reduce(((e,t)=>(e[t.killmail_id]=t,e)),{});Promise.all(Object.values(n).map(i)).then((t=>function(t=[],n={}){const o=[...t].sort(c).filter(u).filter(a),s=o.map((t=>e.Encounter(t,n[t.killmail_id])));console.log("setEncounters",{genuineKillmails:o,killmails:t,recentStubs:n}),s.forEach((e=>e.fetchDetails())),r.encounters.replaceChildren(...s.map((e=>e.render()))),function(t=[],n={}){const o=t.reduce(((e,t)=>e+(n[t.killmail_id]?.zkb?.totalValue||0)),0);r.iskDestroyed.dataset.threat=e.getIskScale(o),r.iskDestroyed.textContent=o>0?`${e.humaniseIsk(o)} destroyed`:"CLEAR"}(s,n)}(t,n))).catch(console.error)}(t))).then(n).catch(s)}()}function i(t={}){return e.libNet.load(`${e.ENDPOINT_ESI}/killmails/${t.killmail_id}/${t.zkb.hash}`)}function c(e,t){return t.killmail_id-e.killmail_id}function u(t){return!e.TYPE_IDS_IGNORED.includes(t.victim.ship_type_id)}function a(e){const t=new Date(e.killmail_time),n=new Date;return Math.abs(t-n)<=36e5}function l(){return n}}})(window.E),(e=>{"use strict";const t=document.getElementById("templatePilot");e.Pilot=({character_id:n,ship_type_id:o},r=!1,s=!1)=>{const i=document.importNode(t.content,!0).firstChild,c={shipPic:i.querySelector(".Pilot-ship-pic"),ship:i.querySelector(".Pilot-ship"),name:i.querySelector(".Pilot-name")};return i.dataset.isVictim=s,i.dataset.isCompact=r,{fetchDetails:function(){(function(){function t(e){console.error({fetchInfo:e})}e.libNet.load(`${e.ENDPOINT_ESI}/characters/${l()}`).then((e=>{return t=e.name,c.name.textContent=t,void c.name.classList.toggle("busy",!1);var t})).catch(t)})(),e.libNet.load(`${e.ENDPOINT_ESI}/universe/types/${a()}`).then(u).catch(console.error)},getShipId:a,getPilotId:l,render:function(){return i}};function u(e){console.log({setShip:e}),c.ship.textContent=e.name,c.shipPic.src=`https://images.evetech.net/types/${e.type_id}/render?size=32`,c.shipPic.alt=e.name}function a(){return o}function l(){return n}}})(window.E);
